// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id         String     @id @default(uuid())
  email      String     @unique
  password   String
  firstName  String
  lastName   String
  role       Role       @default(TENANT)
  properties Property[] @relation("LandlordProperties")
  bookings   Booking[]
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt

  RefreshToken RefreshToken[]

  TenantInvitation TenantInvitation[]

  landlordLeases Lease[] @relation("LandlordLeases")
  tenantLeases   Lease[] @relation("TenantLeases")
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique @db.VarChar(512)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())
}

model Property {
  id           String         @id @default(uuid())
  title        String
  description  String
  address      String
  price        Float
  status       PropertyStatus @default(AVAILABLE)
  landlordId   String
  propertyType PropertyType

  numberOfBeds  Float?
  numberOfBaths Float?
  landSize      Float?
  landSizeUnit  String?
  houseSize     Float?

  isFurnished      Boolean?
  apartmentComplex String?

  landlord  User            @relation("LandlordProperties", fields: [landlordId], references: [id], onDelete: Cascade)
  images    PropertyImage[]
  bookings  Booking[]
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt

  Issue Issue[]

  TenantInvitation TenantInvitation[]

  Lease Lease[]
}

model PropertyImage {
  id         String   @id @default(uuid())
  url        String
  propertyId String
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
}

model Booking {
  id           String            @id @default(uuid())
  tenantId     String?
  propertyId   String
  startDate    DateTime
  endDate      DateTime
  status       BookingStatus     @default(PENDING)
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  user         User?             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  property     Property          @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  invitation   TenantInvitation? @relation(fields: [invitationId], references: [id])
  invitationId String?           @unique
}

model TenantInvitation {
  id           String           @id @default(uuid())
  email        String
  token        String           @unique @db.VarChar(512)
  status       InvitationStatus @default(PENDING)
  expiresAt    DateTime
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  acceptedById String?
  acceptedBy   User?            @relation(fields: [acceptedById], references: [id])
  propertyId   String?
  property     Property?        @relation(fields: [propertyId], references: [id])
  booking      Booking?         @relation()
}

model Payment {
  id        String        @id @default(uuid())
  leaseId   String
  amount    Float
  dueDate   DateTime
  paidAt    DateTime?
  status    PaymentStatus @default(PENDING)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  lease Lease @relation(fields: [leaseId], references: [id], onDelete: Cascade)

  installment Installment[]

  @@unique([leaseId, dueDate])
}

model Installment {
  id        String    @id @default(uuid())
  paymentId String
  amount    Float
  paidAt    DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  payment Payment @relation(fields: [paymentId], references: [id], onDelete: Cascade)
}

model Issue {
  id          String        @id @default(uuid())
  title       String
  description String
  status      IssueStatus   @default(OPEN)
  propertyId  String
  priority    IssuePriority @default(MEDIUM)
  property    Property      @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  images      IssueImage[]
  reportedAt  DateTime      @default(now())
  resolvedAt  DateTime?
}

model Lease {
  id            String       @id @default(uuid())
  propertyId    String
  tenantId      String
  landLordId    String
  startDate     DateTime
  endDate       DateTime
  rentAmount    Float
  depositAmount Float?
  paymentCycle  PaymentCycle @default(MONTHLY)
  status        LeaseStatus  @default(ACTIVE)
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  tenant   User     @relation("TenantLeases", fields: [tenantId], references: [id], onDelete: Cascade)
  landLord User     @relation("LandlordLeases", fields: [landLordId], references: [id], onDelete: Cascade)

  payments Payment[]
}

enum PaymentCycle {
  WEEKLY
  MONTHLY
  QUARTERLY
  YEARLY
}

enum LeaseStatus {
  ACTIVE
  TERMINATED
  COMPLETED
}

enum Role {
  ADMIN
  LANDLORD
  TENANT
}

enum PropertyStatus {
  AVAILABLE
  RENTED
  PENDING
  DELETED
}

enum BookingStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum PropertyType {
  HOUSE
  APARTMENT
  LAND
  COMMERCIAL
}

enum PaymentStatus {
  PENDING
  PAID
  OVERDUE
  PARTIAL
}

model IssueImage {
  id      String @id @default(uuid())
  url     String
  issueId String
  issue   Issue  @relation(fields: [issueId], references: [id], onDelete: Cascade)
}

enum IssueStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum IssuePriority {
  LOW
  MEDIUM
  HIGH
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
  CANCELED
}
